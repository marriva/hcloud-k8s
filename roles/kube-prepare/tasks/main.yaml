---
- name: Check if server ready
  stat:
    path: /opt/ready.txt
  register: ready
- fail:
    msg: "Server is not ready!!!"
  when: not ready.stat.exists

- name: Configure floating IPs
  template:
    src: ifcfg-eth0:x.j2
    dest: "/etc/sysconfig/network-scripts/ifcfg-eth0:{{ index }}"
  vars:
    ip: "{{ item }}"
  loop: "{{ floating_ipv4 }}"
  loop_control:
    index_var: index

- name: Restart Networking
  shell: systemctl restart network

- name: Create Kubernetes Service directory if it does not exist
  file:
    path: /etc/systemd/system/kubelet.service.d
    state: directory
  
- name: Copy cloud config provider flag for kubeadm
  copy:
    src: "{{ playbook_dir }}/roles/kube-prepare/files/20-hetzner-cloud.conf"
    dest: /etc/systemd/system/kubelet.service.d/20-hetzner-cloud.conf

- name: Create Docker Service directory if it does not exist
  file:
    path: /etc/systemd/system/docker.service.d
    state: directory

- name: Copy docker config for systemd
  copy:
    src: "{{ playbook_dir }}/roles/kube-prepare/files/00-cgroup-systemd.conf"
    dest: /etc/systemd/system/docker.service.d/00-cgroup-systemd.conf

- name: Reload system daemon
  shell: systemctl daemon-reload

- name: Insert/Update sysctl settings for traffic forwarding
  blockinfile:
    path: /etc/sysctl.d/k8s.conf
    block: |
      # Allow IP forwarding for kubernetes
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1
      net.ipv6.conf.all.forwarding = 1
    create: yes

- name: Reload sysctl
  shell: sysctl --system

# - name: Auto Mount BPF filesystem for cilium network plugin
#   mount:
#     path: /sys/fs/bpf
#     src: bpffs
#     fstype: bpf
#     state: mounted
